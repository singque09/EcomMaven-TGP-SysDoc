<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
	integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/hmac-sha1.min.js"
	integrity="sha512-OahNHQh8EnqAptVvXgLLIT3LOv+irJSkED9oyUvGvh1MULTHriuXGIk8RHFfRffj5ejGREfE9IRWoBCPSZ5XGw=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/md5.min.js"
	integrity="sha512-3sGbaDyhjGb+yxqvJKi/gl5zL4J7P5Yh4GXzq+E9puzlmVkIctjf4yP6LfijOUvtoBI3p9pLKia9crHsgYDTUQ=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/enc-base64.min.js"
	integrity="sha512-IKpu1GFk/bQ+2fOc4sXuA6lm7Rct4P7611iDBxY9LReOZ2PpwoDWWqj6GSYejUce1FLxo/d4lxAnKqGWJuBw7g=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
	integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.2/base64.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
	var accessKey = "4k=d=_qSKzjGq2aM^+qu6n_6+^^7O-Kr"
	var secretKey = "ru3W_qbKBL6Emd5G*BUodZt+2LeGIgJ*"

	const stringSplit = (string, splitLength = 1) => {
		if (string === null || splitLength < 1) {
			return false
		}
		string += ''
		const chunks = []
		let pos = 0
		const len = string.length
		while (pos < len) {
			chunks.push(string.slice(pos, pos += splitLength))
		}
		return chunks
	}

	const convertWordArrayToUint8Array = (wordArray) => {
		var len = wordArray.words.length,
			u8_array = new Uint8Array(len << 2),
			offset = 0, word, i
			;
		for (i = 0; i < len; i++) {
			word = wordArray.words[i];
			u8_array[offset++] = word >> 24;
			u8_array[offset++] = (word >> 16) & 0xff;
			u8_array[offset++] = (word >> 8) & 0xff;
			u8_array[offset++] = word & 0xff;
		}
		return u8_array;
	}

	const spiffHexToBase64 = (hex) => {
		let parsedString = ''

		stringSplit(hex, 2).forEach(char => {
			parsedString += String.fromCharCode(parseInt(char, 16))
		})

		console.log(parsedString)

		return Base64.encode(parsedString)
	}

	const spiffAuthHeader = (method, body, contentType, dateString, path) => {
		const md5 = CryptoJS.MD5(body)
		const stringToSign = method + "\n" + md5 + "\n" + contentType + "\n" + dateString + "\n" + path;
		const hmac = CryptoJS.HmacSHA1(stringToSign, secretKey)
		const utf8Arr = convertWordArrayToUint8Array(hmac)
		// const signature = CryptoJS.enc.Base64.stringify(hmac)
		const signature = spiffHexToBase64(hmac)

		return 'SOA ' + accessKey + ':' + signature;
	}

	const spiffRequestHeader = async (method, body, path) => {
		const contentType = 'application/json';
		const dateString = moment().format("ddd, D MMM YYYY H:m:s") + " GMT";

		const requestBody = {
			method, headers: {
				'Content-Type': contentType,
				// 'Date': dateString,
				'Authorization': spiffAuthHeader(method, body, contentType, dateString, path)
			}
		}
		const paramsOrData = method === 'GET' ? { data: body } : {}

		console.log(requestBody)

		return await axios({
			...requestBody,
			url: `//api.spiff.com.au${path}`,
			...paramsOrData
		}).then((response) => response).catch((error) => {
			console.log(error);
		}).then(() => {
			// noop
		});
	}
</script>

<style>
	.container {
		display: none;
	}

	.show {
		display: block;
	}
</style>

[%show_orderlist ids:'[@ids@]' sortby:'[@tmpl_sort_by@]' groupby:'[@tmpl_group_by@]' sortorder:'[@tmpl_sort_order@]'%]
[%param *footer%]
[%show_order id:'[@order_ID@]' customer:'[@username@]' dropshipper:'[@showdropshipper@]'%]
[%param *body%]

[%split delimiter:'; Gift Message ID: '%]
[%param data1%][@extra@][%/param%]
[%param *body%]
[%if [@count@] eq 1%]
[%split delimiter:';'%]
[%param data1%][@data1@][%/param%]
[%param *body%]
[%if [@count@] eq 0%]
[%set [@^^label_spiff_transaction_id@] %][@data1@][%/set%]
[%if%]
[%/param%]
[%/split%]
[%if%]
[%/param%]
[%/split%]

<div class="container [%if [@label_spiff_transaction_id@] ne '' %]show[%/if%]" data-order-count="[@count@]"
	data-spiff-transaction-id="[@label_spiff_transaction_id@]">
	<h2 hidden>[%escape%][@extra@][%/escape%]</h2>
	<img src="https://api.spiff.com.au/api/transactions/[@label_spiff_transaction_id@]/image" width="700" height="500">
</div>
[%/param%]
[%/show_order%]
[%/param%]
[%END show_orderlist%]

<script type="text/javascript">
	var showElements = document.getElementsByClassName("show");

	window.onload = function () {
		for (let x = 0; x < showElements.length; x++) {
			let spiffTransactionId = showElements[x].dataset.spiffTransactionId

			spiffRequestHeader('get', { transactionId: spiffTransactionId, renditionName: "Gift Card Message" }, '/api/outputdata')
		}
	};
</script>