<!-- from spiff -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
	integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/md5.min.js"
	integrity="sha512-3sGbaDyhjGb+yxqvJKi/gl5zL4J7P5Yh4GXzq+E9puzlmVkIctjf4yP6LfijOUvtoBI3p9pLKia9crHsgYDTUQ=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/hmac-sha1.min.js"
	integrity="sha512-OahNHQh8EnqAptVvXgLLIT3LOv+irJSkED9oyUvGvh1MULTHriuXGIk8RHFfRffj5ejGREfE9IRWoBCPSZ5XGw=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript" async src="https://assets.dev.spiff.com.au/api.js"></script>
<script>
	var config = {
		contentType: "application/json",
		accessKey: "4k=d=_qSKzjGq2aM^+qu6n_6+^^7O-Kr",
		secretKey: "ru3W_qbKBL6Emd5G*BUodZt+2LeGIgJ*"
	};
	var paths = {
		outputData: "/api/outputdata/{TRANSACTION_ID}/{RENDITION_NAME}"
	};
	var now = new Date();
	var formatedDate = now.toUTCString();

	const generateToken = (secretKey, method, body, contentType, dateString, path) => {
		const md5Hash = CryptoJS.MD5(body).toString();

		const stringToSign = `${method}\n${md5Hash}\n${contentType}\n${dateString}\n${path}`;
		const hmacHash = CryptoJS.HmacSHA1(stringToSign, secretKey);

		return spiffHexToBase64(hmacHash.toString());
	}

	const b64EncodeUnicode = (str) => {
		return btoa(encodeURIComponent(str));
	};

	const getAuthHeader = (accessKey, secretKey, method, body, contentType, dateString, path) => {
		const signature = generateToken(secretKey, method, body, contentType, dateString, path)

		return `SOA ${accessKey}:${signature}`;
	}

	const spiffHexToBase64 = (hex) => {
		let returnTxt = "";
		for (let pair of hex.match(/.{1,2}/g)) {
			let elem = pair.toString(16).charCodeAt(0);
			returnTxt += elem;
		}
		console.log(returnTxt);

		return b64EncodeUnicode(returnTxt);
	}

	console.log(formatedDate);

	const spiffRequestHeader = (body) => {
		const authHeader = getAuthHeader(
			config.accessKey,
			config.secretKey,
			"GET",
			body,
			config.contentType,
			formatedDate,
			paths.outputData
		);

		fetch(`https://api.spiff.com.au/${paths.outputData}`, {
			method: 'GET',
			headers: {
				'Content-Type': config.contentType,
				'Authorization': authHeader,
				'Date': formatedDate
			}
		}).then(response => response.json())
			.then(data => console.log(data))
			.catch(err => console.log(err));
	}

</script>

<!-- end from spiff -->
<style>
	.container {
		display: none;
	}

	.show {
		display: block;
	}
</style>

[%show_orderlist ids:'[@ids@]' sortby:'[@tmpl_sort_by@]' groupby:'[@tmpl_group_by@]' sortorder:'[@tmpl_sort_order@]'%]
[%param *footer%]
[%show_order id:'[@order_ID@]' customer:'[@username@]' dropshipper:'[@showdropshipper@]'%]
[%param *body%]

[%split delimiter:'; Gift Message ID: '%]
[%param data1%][@extra@][%/param%]
[%param *body%]
[%if [@count@] eq 1%]
[%split delimiter:';'%]
[%param data1%][@data1@][%/param%]
[%param *body%]
[%if [@count@] eq 0%]
[%set [@^^label_spiff_transaction_id@] %][@data1@][%/set%]
[%if%]
[%/param%]
[%/split%]
[%if%]
[%/param%]
[%/split%]

<div class="container [%if [@label_spiff_transaction_id@] ne '' %]show[%/if%]" data-order-count="[@count@]"
	data-spiff-transaction-id="[@label_spiff_transaction_id@]">
	<h2 hidden>[%escape%][@extra@][%/escape%]</h2>
	<img src="https://api.spiff.com.au/api/transactions/[@label_spiff_transaction_id@]/image" width="700" height="500">
</div>
[%/param%]
[%/show_order%]
[%/param%]
[%END show_orderlist%]

<script type="text/javascript">
	var showElements = document.getElementsByClassName("show");

	window.onload = function () {
		for (let x = 0; x < showElements.length; x++) {
			let spiffTransactionId = showElements[x].dataset.spiffTransactionId

			spiffRequestHeader({ transactionId: spiffTransactionId, renditionName: "Gift Card Message" })
		}
	};
</script>